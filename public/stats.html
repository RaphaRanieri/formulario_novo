!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Estat칤sticas do Formul치rio</title>
  <link rel="stylesheet" href="estatistica.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>游늵 Estat칤sticas do Formul치rio</h1>

  <script>
    // Mapeamento das chaves do objeto para os t칤tulos das perguntas
    // ESTA SE칂츾O ABAIXO J츼 EST츼 CORRETA, MAS 칄 A CHAVE PARA PASSAR OS T칈TULOS.
    const titulosPerguntas = {
        motivo1: 'Pergunta 1: Voc칡 se preocupa com sua seguran칞a online?',
        motivo2: 'Pergunta 2: J치 teve problemas com seguran칞a digital?',
        motivo3: 'Pergunta 3: Se sim, acha que aconteceria novamente?'
    };

    // Cores pr칠-definidas para os gr치ficos de pizza
    const cores = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
    ];

    let camposChart = null;
    let perguntasCharts = {}; 

    async function atualizar() {
      try {
        // Busca os dados na API JSON
        const res = await fetch('/estatisticas/dados');
        if (!res.ok) {
            throw new Error(`Erro ao buscar dados: ${res.statusText}`);
        }
        const dados = await res.json();
        
        renderizarGraficoCampos(dados.campos);
        renderizarGraficosPerguntas(dados.perguntas);

      } catch (error) {
        console.error('Falha ao atualizar estat칤sticas:', error);
      }
    }
    
    // 1. Renderiza o Gr치fico de Barras para Campos Preenchidos
    function renderizarGraficoCampos(dadosCampos) {
        // Destr칩i o gr치fico antigo para evitar vazamento de mem칩ria e conflitos
        if (camposChart) camposChart.destroy();
        
        const ctx1 = document.getElementById('camposChart').getContext('2d');
        camposChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: Object.keys(dadosCampos),
                datasets: [{
                    label: 'Contagem de Preenchimentos',
                    data: Object.values(dadosCampos),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: { stepSize: 1 } 
                    } 
                } 
            }
        });
    }

    // 2. Renderiza Gr치ficos de Pizza (Doughnut) para as Perguntas
    function renderizarGraficosPerguntas(dadosPerguntas) {
        const container = document.getElementById('perguntas-container');
        // Limpa e destr칩i gr치ficos anteriores
        container.innerHTML = '';
        Object.keys(perguntasCharts).forEach(key => perguntasCharts[key].destroy());
        perguntasCharts = {};

        Object.keys(dadosPerguntas).forEach((chavePergunta) => {
            const respostas = dadosPerguntas[chavePergunta];
            const labels = Object.keys(respostas);
            const data = Object.values(respostas);
            
            // Pular se n칚o houver dados (opcional, mas bom para evitar gr치ficos vazios)
            const total = data.reduce((a, b) => a + b, 0);
            if (total === 0) return;

            // Cria um novo container e canvas para cada gr치fico
            const chartWrapper = document.createElement('div');
            chartWrapper.style.width = '300px'; 
            chartWrapper.style.height = '350px'; // Altura ajustada para o t칤tulo e legenda
            chartWrapper.style.textAlign = 'center';
            chartWrapper.innerHTML = `<canvas id="${chavePergunta}Chart"></canvas>`;
            container.appendChild(chartWrapper);

            const ctx = document.getElementById(`${chavePergunta}Chart`).getContext('2d');
            
            // Cria o novo gr치fico Doughnut
            perguntasCharts[chavePergunta] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: cores.slice(0, data.length),
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            // O t칤tulo 칠 buscado usando a chave da pergunta no objeto titulosPerguntas
                            text: titulosPerguntas[chavePergunta] || chavePergunta, 
                            padding: {
                                top: 5,
                                bottom: 10
                            }
                        }
                    }
                }
            });
        });
    }


    // Inicia a primeira atualiza칞칚o e configura o intervalo
    atualizar();
    setInterval(atualizar, 5000); 
  </script>
</body>
</html>